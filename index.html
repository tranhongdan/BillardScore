<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bang Diem Bida Online</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <style>
        /* Import font chu */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #2b6cb0;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding: 1rem;
            box-sizing: border-box;
        }

        .container {
            width: 100%;
            max-width: 800px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .header-info {
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin-bottom: 1rem;
            align-items: center;
        }

        .main-content {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            width: 100%;
        }

        @media (min-width: 768px) {
            .main-content {
                flex-direction: row;
            }
        }

        .player-card {
            background-color: #2d3748;
            border: 2px solid #4a5568;
            border-radius: 1rem;
            overflow: hidden;
            flex: 1;
            position: relative;
            display: flex;
            flex-direction: column;
            height: 350px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            transition: all 0.3s;
        }

        .player-card.active {
            border-color: #fbbf24;
            box-shadow: 0 0 15px rgba(251, 191, 36, 0.5);
            transform: scale(1.02);
        }

        .name-input {
            background: transparent;
            border: none;
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
            text-align: center;
            width: 100%;
            padding: 0.5rem;
            outline: none;
            border-bottom: 1px solid #4a5568;
            z-index: 20;
        }

        .score-display {
            font-size: 8rem;
            font-weight: bold;
            color: #ef4444;
            text-align: center;
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            user-select: none;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            z-index: 10;
            pointer-events: none;
        }

        .click-zone {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            display: flex;
            flex-direction: column;
            z-index: 5;
        }

        .btn-up, .btn-down {
            flex: 1;
            width: 100%;
            opacity: 0.1;
            transition: opacity 0.2s;
            cursor: pointer;
        }

        .bg-yellow-zone { background-color: #facc15; }
        .bg-white-zone { background-color: #ffffff; }

        .btn-up:active, .btn-down:active {
            opacity: 0.3;
        }

        .stats-row {
            display: flex;
            justify-content: space-around;
            padding: 0.5rem;
            background-color: rgba(0,0,0,0.2);
            font-weight: bold;
            font-size: 0.9rem;
            color: #cbd5e0;
            z-index: 20;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-top: 1.5rem;
            justify-content: center;
        }

        .btn-control {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: bold;
            cursor: pointer;
            border: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            transition: transform 0.1s;
        }

        .btn-control:active { transform: scale(0.95); }
        .btn-reset { background-color: #e2e8f0; color: #1a202c; }
        .btn-end { background-color: #e53e3e; color: white; }
        .btn-swap { background-color: #d69e2e; color: white; }
        .btn-qr { background-color: #38a169; color: white; }

        #qr-container {
            margin-top: 1rem;
            background: white;
            padding: 1rem;
            border-radius: 1rem;
            display: none;
            flex-direction: column;
            align-items: center;
        }
        #qr-container p { color: black; margin-bottom: 0.5rem; font-weight: bold; }
    </style>
</head>
<body>

    <div class="container">
        <div class="header-info">
            <h1 class="text-2xl font-bold">Bida 3 Bang</h1>
            <div class="text-xl bg-blue-800 px-4 py-1 rounded-lg">
                Hiep: <span id="round-count">1</span>
            </div>
        </div>

        <div class="main-content">
            <div id="p1-card" class="player-card">
                <input type="text" id="p1-name" class="name-input" value="Nguoi 1">
                
                <div class="click-zone" id="p1-zone">
                    <div class="btn-up bg-yellow-zone" onclick="changeScore('p1', 1)"></div>
                    <div class="btn-down bg-yellow-zone" onclick="changeScore('p1', -1)"></div>
                </div>

                <div class="score-display" id="p1-score">0</div>

                <div class="stats-row">
                    <span>Thang: <span id="p1-wins">0</span></span>
                    <span>Luot co: <span id="p1-inn">0</span></span>
                    <span>TB: <span id="p1-avg">0.00</span></span>
                </div>
            </div>

            <div id="p2-card" class="player-card">
                <input type="text" id="p2-name" class="name-input" value="Nguoi 2">
                
                <div class="click-zone" id="p2-zone">
                    <div class="btn-up bg-white-zone" onclick="changeScore('p2', 1)"></div>
                    <div class="btn-down bg-white-zone" onclick="changeScore('p2', -1)"></div>
                </div>

                <div class="score-display" id="p2-score">0</div>

                <div class="stats-row">
                    <span>Thang: <span id="p2-wins">0</span></span>
                    <span>Luot co: <span id="p2-inn">0</span></span>
                    <span>TB: <span id="p2-avg">0.00</span></span>
                </div>
            </div>
        </div>

        <div class="controls">
            <button class="btn-control btn-reset" onclick="resetGame()">Dat Lai (Reset)</button>
            <button class="btn-control btn-end" onclick="endRound()">Ket Thuc Hiep</button>
            <button class="btn-control btn-swap" onclick="swapColor()">Doi Mau Bi</button>
            <button class="btn-control btn-qr" onclick="toggleQR()">Tao Ma QR</button>
        </div>

        <div id="qr-container">
            <p>Quet ma de dieu khien chung:</p>
            <div id="qrcode"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // --- CAU HINH FIREBASE CUA BAN ---
        const firebaseConfig = {
            apiKey: "AIzaSyAjAWxH4vaiioTvcKPDae8weW8fr0EoN7M",
            authDomain: "blscore.firebaseapp.com",
            databaseURL: "https://blscore-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "blscore",
            storageBucket: "blscore.firebasestorage.app",
            messagingSenderId: "444177467821",
            appId: "1:444177467821:web:b3b3c78ecc029d06f4f924"
        };

        // Khoi tao Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- QUAN LY ROOM ID ---
        const urlParams = new URLSearchParams(window.location.search);
        let roomId = urlParams.get('room');

        // Tu dong tao Room ID neu chua co
        if (!roomId) {
            roomId = Math.random().toString(36).substring(2, 7).toUpperCase();
            const newUrl = window.location.protocol + "//" + window.location.host + window.location.pathname + '?room=' + roomId;
            window.history.pushState({path: newUrl}, '', newUrl);
        }

        const roomRef = ref(db, 'phong_choi/' + roomId);

        // --- STATE MAC DINH ---
        let gameState = {
            round: 1,
            swapped: false,
            activePlayer: null,
            p1: { name: "Nguoi 1", score: 0, wins: 0, innings: 0 },
            p2: { name: "Nguoi 2", score: 0, wins: 0, innings: 0 }
        };

        // --- DONG BO DU LIEU ---
        
        // Day du lieu len Server
        function syncData() {
            set(roomRef, gameState);
        }

        // Lang nghe du lieu tu Server
        onValue(roomRef, (snapshot) => {
            const data = snapshot.val();
            if (data) {
                gameState = data;
                renderUI();
            } else {
                syncData(); // Tao phong moi
            }
        });

        // --- CAP NHAT GIAO DIEN ---
        function renderUI() {
            // Ten
            document.getElementById('p1-name').value = gameState.p1.name;
            document.getElementById('p2-name').value = gameState.p2.name;

            // Diem
            document.getElementById('p1-score').textContent = gameState.p1.score;
            document.getElementById('p2-score').textContent = gameState.p2.score;

            // Thong so
            document.getElementById('p1-wins').textContent = gameState.p1.wins;
            document.getElementById('p2-wins').textContent = gameState.p2.wins;
            document.getElementById('p1-inn').textContent = gameState.p1.innings;
            document.getElementById('p2-inn').textContent = gameState.p2.innings;

            // Diem trung binh
            let avg1 = gameState.p1.innings > 0 ? (gameState.p1.score / gameState.p1.innings).toFixed(2) : "0.00";
            let avg2 = gameState.p2.innings > 0 ? (gameState.p2.score / gameState.p2.innings).toFixed(2) : "0.00";
            document.getElementById('p1-avg').textContent = avg1;
            document.getElementById('p2-avg').textContent = avg2;

            document.getElementById('round-count').textContent = gameState.round;

            // Mau sac bi
            const zone1 = document.getElementById('p1-zone').children;
            const zone2 = document.getElementById('p2-zone').children;
            
            if (gameState.swapped) {
                updateColorClass(zone1, 'bg-white-zone', 'bg-yellow-zone');
                updateColorClass(zone2, 'bg-yellow-zone', 'bg-white-zone');
            } else {
                updateColorClass(zone1, 'bg-yellow-zone', 'bg-white-zone');
                updateColorClass(zone2, 'bg-white-zone', 'bg-yellow-zone');
            }

            // Hieu ung Active
            document.getElementById('p1-card').classList.remove('active');
            document.getElementById('p2-card').classList.remove('active');
            
            if (gameState.activePlayer === 'p1') {
                document.getElementById('p1-card').classList.add('active');
            } else if (gameState.activePlayer === 'p2') {
                document.getElementById('p2-card').classList.add('active');
            }
        }

        function updateColorClass(elements, addClass, removeClass) {
            for (let el of elements) {
                el.classList.add(addClass);
                el.classList.remove(removeClass);
            }
        }

        // --- HAM GLOBAL (GOI TU HTML) ---

        window.changeScore = function(player, delta) {
            if (gameState.activePlayer !== player) {
                gameState.activePlayer = player;
                gameState[player].innings += 1;
            }
            
            let newScore = gameState[player].score + delta;
            if (newScore < 0) newScore = 0;
            
            gameState[player].score = newScore;
            syncData();
        };

        window.endRound = function() {
            if (!confirm("Ban co chac muon ket thuc hiep nay?")) return;

            if (gameState.p1.score > gameState.p2.score) {
                gameState.p1.wins++;
            } else if (gameState.p2.score > gameState.p1.score) {
                gameState.p2.wins++;
            }

            gameState.p1.score = 0;
            gameState.p1.innings = 0;
            gameState.p2.score = 0;
            gameState.p2.innings = 0;
            gameState.activePlayer = null;
            gameState.round++;
            
            syncData();
        };

        window.resetGame = function() {
            if (!confirm("Xoa toan bo du lieu va choi lai tu dau?")) return;
            
            gameState.round = 1;
            gameState.activePlayer = null;
            gameState.p1.score = 0; gameState.p1.wins = 0; gameState.p1.innings = 0;
            gameState.p2.score = 0; gameState.p2.wins = 0; gameState.p2.innings = 0;
            
            syncData();
        };

        window.swapColor = function() {
            gameState.swapped = !gameState.swapped;
            syncData();
        };

        window.toggleQR = function() {
            const qrBox = document.getElementById('qr-container');
            const qrCodeDiv = document.getElementById('qrcode');
            
            if (qrBox.style.display === 'flex') {
                qrBox.style.display = 'none';
            } else {
                qrBox.style.display = 'flex';
                qrCodeDiv.innerHTML = "";
                new QRCode(qrCodeDiv, {
                    text: window.location.href,
                    width: 150,
                    height: 150
                });
            }
        };

        // Luu ten khi nhap
        document.getElementById('p1-name').addEventListener('input', (e) => {
            gameState.p1.name = e.target.value;
            syncData();
        });
        document.getElementById('p2-name').addEventListener('input', (e) => {
            gameState.p2.name = e.target.value;
            syncData();
        });

    </script>
</body>
</html>
