<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Billiard Score App - Sync</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #2b6cb0;
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 1rem;
            box-sizing: border-box;
        }
        .container {
            width: 100%;
            max-width: 600px;
            display: flex;
            flex-direction: column;
            align-items: center;
            flex-grow: 1;
        }
        .main-content {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 100%;
            position: relative;
        }

        /* Responsive layout for landscape mode */
        @media (min-width: 600px) {
            body {
                flex-direction: column;
                justify-content: center;
            }
            .main-content {
                flex-direction: row;
                justify-content: center;
                gap: 2rem;
            }
            .button-container {
                flex-direction: row;
                margin-top: 2rem;
            }
        }

        .score-section {
            display: grid;
            grid-template-rows: auto 1fr;
            border: 2px solid #4a5568;
            border-radius: 1rem;
            overflow: hidden;
            margin-bottom: 1rem;
            background-color: #2d3748;
            box-shadow: 4px 4px 6px -1px rgba(0, 0, 0, 0.5), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            height: 300px;
            position: relative;
            flex-grow: 1;
            cursor: pointer;
            transition: transform 0.3s ease-in-out;
            transform: scale(0.9);
            opacity: 0.8;
        }
        .score-section.active {
            transform: scale(1.05);
            border-color: #fca5a5;
            box-shadow: 0 8px 10px rgba(0, 0, 0, 0.4);
            opacity: 1;
        }
        .score-display {
            font-size: 10rem;
            font-weight: bold;
            color: #ef4444;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
            z-index: 10;
            pointer-events: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        .name-container {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0 0.5rem;
            background-color: #2d3748;
            z-index: 20;
        }
        .name-input {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
            text-align: center;
            outline: none;
            flex-grow: 1;
            max-width: 15ch; 
            pointer-events: auto; /* Cho phep nhap ten moi luc */
        }
        .stats-container {
            display: flex;
            justify-content: space-around;
            position: absolute;
            bottom: 0.5rem;
            left: 0;
            width: 100%;
            z-index: 20;
        }
        .stats {
            font-size: 1rem;
            font-weight: bold;
            color: #4a5568;
        }

        .stats.win-effect {
            animation: win-effect-animation 3s forwards;
        }

        @keyframes win-effect-animation {
            0% { transform: scale(1); color: #4a5568; }
            5% { transform: scale(1.5) rotate(5deg); }
            10% { transform: scale(1.5) rotate(-5deg); }
            15% { transform: scale(1.5) rotate(5deg); }
            20% { transform: scale(1.5) rotate(-5deg); }
            25% { transform: scale(1.5) rotate(0deg); }
            50% { transform: scale(1.5); }
            100% { transform: scale(1); }
        }

        .score-area {
            display: grid;
            grid-template-rows: 1fr 1fr;
            width: 100%;
            height: 100%;
            position: relative;
            background-color: transparent;
            gap: 4px;
        }
        .score-area .top {
            transition: background-color 0.2s, transform 0.1s;
            border-bottom: none;
        }
        .score-area .bottom {
            transition: background-color 0.2s, transform 0.1s;
        }
        /* Class mau sac duoc dieu khien boi JS */
        .color-style-1 .top, .color-style-1 .bottom { background-color: #fce303; }
        .color-style-2 .top, .color-style-2 .bottom { background-color: #fff; }

        .score-area .top:active, .score-area .bottom:active {
            transform: scale(0.98);
        }

        .button-container {
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            width: 100%;
            margin-top: 1rem;
        }
        @media (min-width: 600px) {
            .button-container {
                width: 100%;
                max-width: 600px;
                flex-direction: row;
            }
        }
        .end-round-button, .reset-button, .swap-colors-button, .qr-button {
            background-color: #2b6cb0;
            color: white;
            font-weight: bold;
            padding: 1rem 2rem;
            border-radius: 9999px;
            box-shadow: 0 8px 10px rgba(0, 0, 0, 0.4);
            transition: background-color 0.2s, transform 0.1s;
        }
        .end-round-button { background-color: #48bb78; }
        .end-round-button:hover { background-color: #38a169; }
        .reset-button:hover { background-color: #2c5282; }
        .swap-colors-button { background-color: #d97706; }
        .swap-colors-button:hover { background-color: #b45309; }
        .qr-button { background-color: #10b981; } /* Mau xanh la */
        .qr-button:hover { background-color: #059669; }

        .end-round-button:active, .reset-button:active, .swap-colors-button:active, .qr-button:active {
            transform: scale(0.98);
        }
       
        #messageBox {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 1rem 2rem;
            border-radius: 9999px;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            pointer-events: none;
            z-index: 100;
        }

        @keyframes score-flip {
            0% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            50% { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
            51% { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }
        .score-display.flip {
            animation: score-flip 0.5s ease-in-out;
        }

        /* QR Code Container */
        #qr-container {
            display: none;
            flex-direction: column;
            align-items: center;
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 50;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        }
        #qr-container p { color: #2d3748; margin-bottom: 10px; font-weight: bold; }
        .close-qr {
            margin-top: 10px;
            background: #ef4444;
            color: white;
            border: none;
            padding: 5px 15px;
            border-radius: 5px;
            cursor: pointer;
        }
    </style>
</head>
<body class="bg-[#2b6cb0] text-white">

    <div class="container mx-auto">
        <h2 id="round-counter" class="text-xl font-bold mb-4">Round: 1</h2>
        <div class="main-content">
            <div id="player1" class="score-section w-full">
                <div class="name-container">
                    <input type="text" id="name1" class="name-input" value="Player 1" maxlength="10">
                </div>
                <div class="stats-container player-1">
                    <span class="stats wins-1">Win: 0</span>
                    <span class="stats avg-1">AVG: 0.00</span>
                    <span class="stats shots-1">Inn: 0</span>
                </div>
                <div class="score-area color-style-1">
                    <span class="score-display">0</span>
                    <div class="top" data-player="player1" data-value="1"></div>
                    <div class="bottom" data-player="player1" data-value="-1"></div>
                </div>
            </div>

            <div id="player2" class="score-section w-full">
                <div class="name-container">
                    <input type="text" id="name2" class="name-input" value="Player 2" maxlength="10">
                </div>
                <div class="stats-container player-2">
                    <span class="stats wins-2">Win: 0</span>
                    <span class="stats avg-2">AVG: 0.00</span>
                    <span class="stats shots-2">Inn: 0</span>
                </div>
                <div class="score-area color-style-2">
                    <span class="score-display">0</span>
                    <div class="top" data-player="player2" data-value="1"></div>
                    <div class="bottom" data-player="player2" data-value="-1"></div>
                </div>
            </div>
        </div>
        
        <div class="button-container">
            <button class="end-round-button" id="endRoundBtn">End Round</button>
            <button class="reset-button" id="resetBtn">Reset All</button>
            <button class="swap-colors-button" id="swapColorsBtn">Swap Colors</button>
            <button class="qr-button" id="qrBtn">QR Code</button>
        </div>
    </div>

    <div id="messageBox"></div>

    <div id="qr-container">
        <p>Quet ma de dieu khien</p>
        <div id="qrcode"></div>
        <button class="close-qr" onclick="document.getElementById('qr-container').style.display='none'">Dong</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // Cau hinh Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAjAWxH4vaiioTvcKPDae8weW8fr0EoN7M",
            authDomain: "blscore.firebaseapp.com",
            databaseURL: "https://blscore-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "blscore",
            storageBucket: "blscore.firebasestorage.app",
            messagingSenderId: "444177467821",
            appId: "1:444177467821:web:b3b3c78ecc029d06f4f924"
        };

        // Khoi tao Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- QUAN LY ROOM ID ---
        const urlParams = new URLSearchParams(window.location.search);
        let roomId = urlParams.get('room');
        
        if (!roomId) {
            roomId = Math.random().toString(36).substring(2, 7).toUpperCase();
            const newUrl = window.location.protocol + "//" + window.location.host + window.location.pathname + '?room=' + roomId;
            window.history.pushState({path: newUrl}, '', newUrl);
        }

        const roomRef = ref(db, 'rooms/' + roomId);

        // --- TRANG THAI CUA UNG DUNG (STATE) ---
        // Dua tat ca bien vao state de dong bo
        let state = {
            player1: { name: "Player 1", score: 0, wins: 0, shots: 0 },
            player2: { name: "Player 2", score: 0, wins: 0, shots: 0 },
            rounds: 1,
            currentPlayer: null,
            isSwapped: false, // Bien de theo doi doi mau
            timestamp: Date.now()
        };

        // --- DONG BO DU LIEU LEN FIREBASE ---
        function syncState() {
            state.timestamp = Date.now();
            set(roomRef, state);
        }

        // --- LANG NGHE DU LIEU TU FIREBASE ---
        onValue(roomRef, (snapshot) => {
            const data = snapshot.val();
            if (data) {
                // Cap nhat state cuc bo tu server
                state = data;
                // Cap nhat giao dien
                renderUI();
            } else {
                // Phong moi, day du lieu mac dinh len
                syncState();
            }
        });

        // --- HAM CAP NHAT GIAO DIEN (RENDER) ---
        function renderUI() {
            // Cap nhat ten
            const input1 = document.getElementById('name1');
            const input2 = document.getElementById('name2');
            if (document.activeElement !== input1) input1.value = state.player1.name;
            if (document.activeElement !== input2) input2.value = state.player2.name;

            // Cap nhat Round
            document.getElementById('round-counter').textContent = `Round: ${state.rounds}`;

            // Cap nhat thong so Player 1
            updatePlayerDOM('player1', state.player1);
            // Cap nhat thong so Player 2
            updatePlayerDOM('player2', state.player2);

            // Cap nhat mau sac (Swap)
            const area1 = document.getElementById('player1').querySelector('.score-area');
            const area2 = document.getElementById('player2').querySelector('.score-area');
            
            // Xoa class cu
            area1.classList.remove('color-style-1', 'color-style-2');
            area2.classList.remove('color-style-1', 'color-style-2');

            if (state.isSwapped) {
                area1.classList.add('color-style-2');
                area2.classList.add('color-style-1');
            } else {
                area1.classList.add('color-style-1');
                area2.classList.add('color-style-2');
            }

            // Cap nhat trang thai Active (luot danh)
            const p1Sec = document.getElementById('player1');
            const p2Sec = document.getElementById('player2');
            p1Sec.classList.remove('active');
            p2Sec.classList.remove('active');
            
            if (state.currentPlayer === 'player1') p1Sec.classList.add('active');
            if (state.currentPlayer === 'player2') p2Sec.classList.add('active');
        }

        function updatePlayerDOM(pid, pData) {
            const root = document.getElementById(pid);
            // Cap nhat diem (co the them hieu ung flip neu muon, o day cap nhat truc tiep de dong bo nhanh)
            const scoreDisplay = root.querySelector('.score-display');
            if (scoreDisplay.textContent != pData.score) {
                scoreDisplay.textContent = pData.score;
                scoreDisplay.classList.add('flip');
                setTimeout(() => scoreDisplay.classList.remove('flip'), 250);
            }

            root.querySelector(`.stats.wins-${pid.slice(-1)}`).textContent = `Win: ${pData.wins}`;
            root.querySelector(`.stats.shots-${pid.slice(-1)}`).textContent = `Inn: ${pData.shots}`;
            
            let avg = 0;
            if (pData.shots > 0) avg = pData.score / pData.shots;
            root.querySelector(`.stats.avg-${pid.slice(-1)}`).textContent = `AVG: ${avg.toFixed(2)}`;
        }

        // --- CAC HAM LOGIC (SUA DOI DE DONG BO) ---

        // Xu ly click vao diem
        window.handleScoreClick = (pid, val) => {
            if (state.currentPlayer !== pid) {
                state.currentPlayer = pid;
                state[pid].shots++;
                // Reset diem luot danh neu can (logic hien tai khong co bien currentTurnScore rieng biet trong state goc)
            } else if (val !== undefined && !isNaN(val)) {
                let newScore = state[pid].score + val;
                if (newScore < 0) newScore = 0;
                state[pid].score = newScore;
            }
            syncState();
        };

        // Gan su kien click cho cac vung (thay vi DOMContentLoaded o duoi)
        document.querySelectorAll('.score-section').forEach(section => {
            section.addEventListener('click', (event) => {
                const value = parseInt(event.target.dataset.value);
                // Chi xu ly neu click vao vung co data-value (top/bottom)
                if (!isNaN(value)) {
                    window.handleScoreClick(section.id, value);
                } else {
                    // Neu click vao vung trong de chuyen luot ma khong tang diem (option)
                    // Hien tai logic goc la click vao section de chuyen luot
                    if (state.currentPlayer !== section.id) {
                         state.currentPlayer = section.id;
                         state[section.id].shots++;
                         syncState();
                    }
                }
            });
        });

        // Ket thuc hiep
        document.getElementById('endRoundBtn').addEventListener('click', () => {
            if (state.player1.score > state.player2.score) {
                state.player1.wins++;
                triggerWinEffect('player1');
            } else if (state.player2.score > state.player1.score) {
                state.player2.wins++;
                triggerWinEffect('player2');
            }

            state.player1.score = 0;
            state.player1.shots = 0;
            state.player2.score = 0;
            state.player2.shots = 0;
            state.currentPlayer = null;
            state.rounds++;
            syncState();
        });

        // Reset
        document.getElementById('resetBtn').addEventListener('click', () => {
            if(!confirm("Reset all?")) return;
            state.player1.score = 0; state.player1.wins = 0; state.player1.shots = 0;
            state.player2.score = 0; state.player2.wins = 0; state.player2.shots = 0;
            state.rounds = 1;
            state.currentPlayer = null;
            syncState();
        });

        // Doi mau
        document.getElementById('swapColorsBtn').addEventListener('click', () => {
            state.isSwapped = !state.isSwapped;
            syncState();
        });

        // Nhap ten
        document.getElementById('name1').addEventListener('input', (e) => {
            state.player1.name = e.target.value;
            syncState();
        });
        document.getElementById('name2').addEventListener('input', (e) => {
            state.player2.name = e.target.value;
            syncState();
        });

        // QR Code
        document.getElementById('qrBtn').addEventListener('click', () => {
            const qrContainer = document.getElementById('qr-container');
            const qrcodeDiv = document.getElementById('qrcode');
            
            qrContainer.style.display = 'flex';
            qrcodeDiv.innerHTML = "";
            new QRCode(qrcodeDiv, {
                text: window.location.href,
                width: 200,
                height: 200
            });
        });

        // Hieu ung thang (chay cuc bo tren moi may khi data thay doi)
        function triggerWinEffect(winner) {
            // Ham nay chi de tao hieu ung visual, du lieu da dong bo
            const el = document.getElementById(winner).querySelector(`.stats.wins-${winner.slice(-1)}`);
            el.classList.add('win-effect');
            setTimeout(() => el.classList.remove('win-effect'), 3000);
        }

    </script>
</body>
</html>
